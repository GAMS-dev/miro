stages:
  - prepare
  - build
  - test
  - deploy

image:
  name: registry.gams.com/fproske/gmswebui/gamsmiro-ci:latest


variables:
  BUILD_CI:
    value: "no"
    description: 'Build CI image (yes/no)?'
  PUSH_UNSTABLE_SERVER_IMAGES:
    value: "no"
    description: "Push MIRO Server images to registry.gams.com (tagged as unstable on develop and feature on feature branches) (yes/no)?"


prepare_all:
  tags:
    - linux
  stage: prepare
  script:
    - 'echo "Building on branch: $CI_COMMIT_BRANCH"'
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: always
    - if: '$CI_COMMIT_BRANCH == "develop"'
      when: always
    - if: '$CI_COMMIT_BRANCH == "rc"'
      when: always
    - if: $CI_MERGE_REQUEST_ID
      when: never
    - if: '$CI_PIPELINE_SOURCE == "web"'
    - when: manual

build_build_image_windows:
  tags:
    - windows-shell
  stage: prepare
  before_script:
    # this is to be able to pull and push images
    - New-Item -ItemType Directory -Force -Path %USERPROFILE%/.docker
    - $env:DOCKER_AUTH_CONFIG > %USERPROFILE%/.docker/config.json
  script:
    - cd ci/windows
    - docker build -t $env:CI_REGISTRY_IMAGE/builder-windows:latest .
    - docker push $env:CI_REGISTRY_IMAGE/builder-windows:latest
  rules:
    - if: '$CI_PIPELINE_SOURCE != "push"'
      when: never
    - changes:
      - ci/windows/Dockerfile

lint_job:
  tags:
   - linux
  stage: test
  before_script:
    - git config --global --add safe.directory "$CI_PROJECT_DIR"
    - yarn install --cache-folder .yarn
  script:
   - pre-commit run --all-files
  variables:
    PRE_COMMIT_HOME: ${CI_PROJECT_DIR}/.cache/pre-commit
  cache:
    paths:
      - node_modules/
      - .yarn
      - ${PRE_COMMIT_HOME}
  rules:
    - if: $CI_MERGE_REQUEST_ID
      when: always

build_windows_job:
  tags:
    - windows
  stage: build
  image: $CI_REGISTRY_IMAGE/builder-windows:latest
  variables:
    CSC_LINK: cert.p12
    GIT_SUBMODULE_STRATEGY: normal
  before_script:
    - yarn install --cache-folder .yarn
    - '[IO.File]::WriteAllBytes([io.path]::Combine((Get-Location).path, $env:CSC_LINK), [Convert]::FromBase64String($env:WIN_CERT_FILE_B64))'
  script:
    - yarn dist
  artifacts:
    paths:
      - dist/*.exe
    expire_in: 1 week
  cache:
    - key:
        files:
          - src/miro-pkg-lock.csv
      paths:
        - r
    - key: build-cache-windows
      paths:
        - build/lib_devel/
    - key:
        files:
          - yarn.lock
      paths:
        - .yarn/
    - key:
        files:
          - src/package-lock.json
      paths:
        - src/node_modules/
  needs: [prepare_all]


test_windows_job:
  tags:
    - windows
  stage: test
  image: $CI_REGISTRY_IMAGE/builder-windows:latest
  script:
    - yarn test gams_sys_dir=$env:GAMS_SYS_DIR
  cache:
    - key:
        files:
          - src/miro-pkg-lock.csv
      paths:
        - r
    - key:
        files:
          - yarn.lock
      paths:
        - .yarn/
  needs: [build_windows_job]

test_job_api:
  tags:
    - linux
  stage: test
  image: docker:20.10
  services:
    - name: docker:20.10-dind
    - name: postgres:12.1-alpine
      alias: postgres
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: "/certs"
    FF_NETWORK_PER_BUILD: "true"
    GMS_MIRO_DATABASE_HOST: postgres
    GMS_MIRO_DATABASE: miroapitests
    GMS_MIRO_DATABASE_USER: mirotests
    GMS_MIRO_DATABASE_PWD: mirotests
    POSTGRES_DB: $GMS_MIRO_DATABASE
    POSTGRES_USER: $GMS_MIRO_DATABASE_USER
    POSTGRES_PASSWORD: $GMS_MIRO_DATABASE_PWD
    POSTGRES_HOST_AUTH_METHOD: trust
  before_script:
    # this is to be able to pull and push images
    - mkdir -p $HOME/.docker
    - echo $DOCKER_AUTH_CONFIG > $HOME/.docker/config.json
  script:
    - docker pull ${CI_REGISTRY_IMAGE}/miro-auth-test:unstable && docker tag ${CI_REGISTRY_IMAGE}/miro-auth-test:unstable miro-auth-test || exit 1
    - ./test/run-api-tests.sh
  rules:
    - if: $CI_MERGE_REQUEST_TITLE =~ /^Draft:/
      when: manual
    - if: $CI_MERGE_REQUEST_ID

test_job:
  tags:
    - linux
  stage: test
  services:
    - name: postgres:12.1-alpine
  variables:
    MIRO_STOP_TESTS_ON_FAILURE: "false"
    MIRO_DB_TYPE: postgres
    MIRO_DB_HOST: postgres
    MIRO_DB_NAME: mirotests
    MIRO_DB_USERNAME: mirotests
    MIRO_DB_PASSWORD: mirotests
    POSTGRES_DB: $MIRO_DB_NAME
    POSTGRES_USER: $MIRO_DB_USERNAME
    POSTGRES_PASSWORD: $MIRO_DB_PASSWORD
    POSTGRES_HOST_AUTH_METHOD: trust
  before_script:
    - source /etc/profile.d/ci.sh
    - yarn install --cache-folder .yarn
  script:
    - mchecklic
    - mtestall
  interruptible: true
  cache:
    paths:
      - node_modules/
      - .yarn
  artifacts:
    when: always
    reports:
      junit: src/tests/testthat/test-out.xml
    paths:
      - src/tests/logs-tests
    expire_in: 1 week
  rules:
    - if: $CI_MERGE_REQUEST_TITLE =~ /^Draft:/
      when: manual
    - if: $CI_MERGE_REQUEST_ID

update_doc_job:
  tags:
    - linux
  stage: deploy
  before_script:
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_KNOWN_HOSTS" >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - rsync -rlptvz doc/* ubuntu@new.gams.com:/var/www/html/staging.gams.com/public_html/miro
  rules:
    - if: $CI_MERGE_REQUEST_ID
      when: always
    - when: manual
    - allow_failure: true
  needs: []
